/*
* Copyright 2019 Seven Spikes Ltd. All rights reserved. (http://www.nop-templates.com)
* http://www.nop-templates.com/t/licensinginfo
*/

!function(y,m,g){var d,p,l,u,f,v,F,T,e;function t(){var e=g.getHiddenValFromDom("#create-condition-group-url"),t=g.getHiddenValFromDom("#condition-id"),o=y("#conditionResources").attr("data-createConditionGroupFail");if(""!==e&&""!==t){var n={conditionId:t};addAntiForgeryToken(n),y.ajax({cache:!1,type:"POST",data:n,url:e,success:function(e){a(e),r(e)},error:function(){alert(o)}})}}function o(){var e=g.getHiddenValFromDom("#delete-condition-group-url"),t=y(this).closest(".condition-group-grid"),o=y(t).attr("id"),n=y(t).attr("data-conditionGroupId"),i=y("#conditionResources").attr("data-deleteConditionGroupFail");if(""!==e&&n&&o){var a={conditionGroupId:n};addAntiForgeryToken(a),y.ajax({cache:!1,type:"POST",data:a,url:e,success:function(){y("#"+o).data("kendoGrid").destroy(),y("#"+o).parent(".condition-group-wrapper").remove()},error:function(){alert(i)}})}}function n(){var e=g.getHiddenValFromDom("#update-condition-url"),t=g.getHiddenValFromDom("#condition-id"),o=g.getHiddenValFromDom("#condition #ConditionName"),n=g.getHiddenValFromDom("#condition #DefaultConditionValue"),i=y("#conditionResources").attr("data-updateConditionFail"),a={ConditionName:o,Active:!!y("#condition #Active").attr("checked"),DefaultConditionValue:n,conditionId:t};addAntiForgeryToken(a),y.ajax({cache:!1,type:"POST",data:a,url:e,error:function(){alert(i)}})}function i(){var e=g.getHiddenValFromDom("#update-default-condition-group-statement-url"),t=g.getHiddenValFromDom("#condition-id"),o=y("#conditionResources").attr("data-updateConditionStatementFail"),n={conditionId:t,defaultConditionStatementValue:y("#condition #DefaultConditionValue").find(":selected").val()};addAntiForgeryToken(n),y.ajax({cache:!1,type:"POST",data:n,url:e,error:function(){alert(o)}})}function a(e){var t='<div class="condition-group-wrapper"><div class="condition-group-grid" id="'+("condition-group-grid-"+e)+'" data-conditionGroupId="'+e+'"></div><div class="group-dependancy-text"><p>--OR--</p></div></div>';y("#condition-groups-wrapper").append(t)}function r(i){var e="condition-group-grid-"+i,t=g.getHiddenValFromDom("#read-condition-group-url"),o=g.getHiddenValFromDom("#update-condition-statement-url"),n=g.getHiddenValFromDom("#destroy-condition-statement-url"),a=g.getHiddenValFromDom("#create-condition-statement-url"),r=new m.data.DataSource({transport:{type:"json",read:{url:t,cache:!1,dataType:"json",data:addAntiForgeryToken},update:{url:o,type:"POST",dataType:"json",data:addAntiForgeryToken},destroy:{url:n,cache:!1,dataType:"json",data:addAntiForgeryToken},create:{url:a,type:"POST",dataType:"json",data:addAntiForgeryToken},parameterMap:function(e,t){if("read"===t)return addAntiForgeryToken({conditionGroupId:i});if("destroy"===t)return addAntiForgeryToken({conditionStatementId:e.ConditionStatementId});if("update"!==t&&"create"!==t)return JSON.stringify(e);var o=y("#condition-property-value").val(),n={conditionGroupId:i,id:e.ConditionStatementId,conditionTypeId:e.ConditionType.Id,conditionPropertyValue:e.ConditionProperty.Id,operatorTypeValue:e.ConditionPropertyOperator.Id,value:o};return addAntiForgeryToken(n)}},schema:{data:"Data",total:"Total",errors:"Errors",model:{id:"Id",fields:{Id:{type:"number",editable:!1},ConditionType:{defaultValue:{Id:0,Name:f}},ConditionProperty:{defaultValue:{Id:0,Name:v}},ConditionPropertyOperator:{defaultValue:{Id:0,Name:F}},ConditionPropertyValue:{defaultValue:{Id:0,Name:T}}}}},requestEnd:function(e){"create"!==e.type&&"update"!==e.type||this.read()},error:function(e){display_kendoui_grid_error(e),this.cancelChanges()},pageSize:g.getHiddenValFromDom("#defaultGridPageSize")});y("#"+e).kendoGrid({dataSource:r,pageable:{refresh:!0,pageSizes:g.getHiddenValFromDom("#gridPageSizes").split(",")},sortable:!0,editable:{mode:"popup",template:m.template(y("#popup_editor").html()),window:{animation:!1,width:400}},edit:function(e){!function(t){var e=g.getHiddenValFromDom("#get-condition-type-url"),o=g.getHiddenValFromDom("#available-condition-types"),n=JSON.parse(o),i=Object.keys(n),a=y("#condition-type").kendoDropDownList({optionLabel:f,dataValueField:"Id",dataTextField:"Name",dataSource:{type:"json",transport:{read:{url:e,type:"POST",dataType:"json",data:addAntiForgeryToken({conditionTypeIds:i})}}},change:c}).data("kendoDropDownList"),r=g.getHiddenValFromDom("#get-condition-properties-url"),d=y("#condition-property").kendoDropDownList({optionLabel:v,autoBind:!1,cascadeFrom:"condition-type",dataValueField:"Id",dataTextField:"Name",dataSource:{serverFiltering:!0,type:"json",transport:{read:{url:r,type:"POST",dataType:"json",contentType:"application/json"},parameterMap:function(e,t){return"read"!==t?e:(e.conditionPropertyIds=n[a.value()],JSON.stringify(e))}}},change:function(){var e=y("#condition-property-value").getKendoDropDownList(),t=y("#condition-property-value").getKendoComboBox(),o=y("#condition-property-value").getKendoNumericTextBox();e?e.value(""):t?t.value(""):o?o.value(""):y("#condition-property-value").val("")}}).data("kendoDropDownList"),p=g.getHiddenValFromDom("#get-condition-property-operators-url"),l=(y("#condition-property-operator").kendoDropDownList({optionLabel:F,autoBind:!1,cascadeFrom:"condition-property",dataValueField:"Id",dataTextField:"Name",dataSource:{serverFiltering:!0,type:"json",transport:{read:{url:p,type:"POST",dataType:"json",contentType:"application/json"},parameterMap:function(e,t){return"read"!==t?e:(u(e),JSON.stringify(e))}}}}).data("kendoDropDownList"),g.getHiddenValFromDom("#get-condition-property-value-type-url"));function u(e){e.filter||(e.filter={}),e.filter.filters||(e.filter.filters=[]),e.filter.filters.unshift({field:"condition-property",operator:"eq",value:parseInt(d.value())}),e.filter.filters.unshift({field:"condition-type",operator:"eq",value:parseInt(a.value())})}function c(){var e=y("#condition-property-value").getKendoDropDownList(),t=y("#condition-property-value").getKendoComboBox(),o=y("#condition-property-value").getKendoNumericTextBox();e?(e.destroy(),e.wrapper.remove()):t?(t.destroy(),t.wrapper.remove()):o&&(o.destroy(),o.wrapper.remove()),y("#condition-property-value").remove()}function s(){var e=g.getHiddenValFromDom("#get-condition-property-values-url");return new m.data.DataSource({serverFiltering:!0,type:"json",transport:{read:{url:e,type:"POST",dataType:"json",contentType:"application/json"},parameterMap:function(e,t){return"read"!==t?e:(u(e),JSON.stringify(e))}}})}y("#condition-property-value-type").kendoDropDownList({autoBind:!1,cascadeFrom:"condition-property",dataValueField:"Id",dataTextField:"Name",dataSource:{serverFiltering:!0,type:"json",transport:{read:{url:l,type:"POST",dataType:"json",contentType:"application/json",complete:function(){!function(e){c(),y("<input />").attr({type:"text",id:"condition-property-value",name:"Value",required:"required",style:"width: 230px"}).appendTo("#condition-property-value-container"),t.isNew()||y("#condition-property-value").val(t.ConditionPropertyValue.Id),"1"===e?y("#condition-property-value").kendoComboBox({autoBind:!t.isNew(),placeholder:T,filter:"contains",dataValueField:"Id",dataTextField:"Name",delay:500,change:function(e){var t=e.sender;if(t.value()&&-1===t.selectedIndex){var o=y("#conditionResources").attr("data-invalidEntry");alert(o),t.value("")}},dataSource:s()}):"2"===e?y("#condition-property-value").kendoDropDownList({autoBind:!t.isNew(),optionLabel:T,dataValueField:"Id",dataTextField:"Name",dataSource:s()}):"3"===e&&y("#condition-property-value").kendoNumericTextBox()}(y("#condition-property-value-type").data("kendoDropDownList").value())}},parameterMap:function(e,t){return"read"!==t?e:(u(e),JSON.stringify(e))}}}}).data("kendoDropDownList").wrapper.hide()}(e.model)},save:function(e){e.model.isNew()||(e.model.dirty=!0)},cancel:function(){this.cancelChanges()},toolbar:["create","destroy"],columns:[{field:"ConditionType",title:d,width:100,template:"#: ConditionType ? ConditionType.Name : null #"},{field:"ConditionProperty",title:p,width:100,template:"#: ConditionProperty ? ConditionProperty.Name : null #"},{field:"ConditionPropertyOperator",title:l,width:100,template:"#: ConditionPropertyOperator ? ConditionPropertyOperator.Name : null #"},{field:"ConditionPropertyValue",title:u,width:100,template:"#: ConditionPropertyValue ? ConditionPropertyValue.Name : null #"},{command:["edit","destroy"],title:"&nbsp;",width:"150px"}]})}y(document).ready(function(){!function(){var e=y.parseJSON(g.getHiddenValFromDom("#condition-groups"));if(null!=e)for(var t=0;t<e.length;t++)a(e[t]),r(e[t])}(),y(document).on("click","a.add-condition-group",t),y(document).on("click",".k-grid-toolbar a.k-grid-delete",o),y(document).on("change","#condition #ConditionName, #condition #Active",n),y(document).on("change","#condition #DefaultConditionValue",i),e=y("#conditionResources"),d=e.attr("data-conditionGroupType"),p=e.attr("data-conditionGroupProperty"),l=e.attr("data-conditionGroupOperator"),u=e.attr("data-conditionGroupValue"),f=e.attr("data-conditionGroupSelectType"),v=e.attr("data-conditionGroupSelectProperty"),F=e.attr("data-conditionGroupSelectOperator"),T=e.attr("data-conditionGroupSelectValue")})}(jQuery,kendo,sevenSpikesCore);